<!DOCTYPE html>
<html>

<head>

<style type="text/css">
.buttonText {
	background  : none;
	border: none;
	cursor  : pointer;
	font-size   : 12px;
	color   : #000;
	margin      : 0px;
	padding     : 0px;

}

</style>
<meta http-equiv="content-type" content="text/html; charset=UTF8">
<script type="text/javascript" src="./js/d3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="./js/d3.tip.js"></script>
<script type="text/javascript" src="./js/stackedBar.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<link rel="stylesheet" type="text/css" href="./style/styles.css">

</head>

<body style="background:#fBfBfB;">
<h2 style="margin-left: 5px;">Auction Helper</h2>
<div class="container" style="margin-left: 25px;">
	<div class="row">
			<div style="display: inline;"> 
			<h3>Enter Data (<button class="toggle buttonText">Hide Instructions</button>) </h3> 
			</div>
			<ol class="toggle-list">
				<li>
					Data is expected in TSV (tab separated value) format in which the first column is titled "Names" and all column headers are unique.
					<ul>
						<li>
						The easiest way to do this is to type up your auction in excel, then copy and paste from excel into the text box below.
						</li>
					</ul>
				</li>
				<li>
					Additional columns should have auction participant names as headers and rows corresponding to bets. Bets are normalized out of $100.
				</li>
				<li> 
					Here is an example input in exel and in TSV:
					<ul>
						<li> Copy and paste the output into the text box to see how it works</li>
					</ul>

					<div class="row">
						<div class="col-md-4">
							<pre>Names	Adam	Melanee	Jade	Chloe
Kitchen Table	1000	1	1	2
Chairs	1	90	1	1
TV	1	1	90	1
Sofa	1	1	2	90
Painting	1	1	1	1
Forks	1	1	1	1
Shower Curtain	1	2	1	1
Flooring	1	1	1	1
Fridge Items	1	1	1	1
Art Supplies	2	1	1	1
				</pre>
						</div>
						<div class="col-md-4">
							<img src="./example.png">
						</div>
					</div>
				</li>
				<li>
					Click "Run Auction".
				</li>
			</ol>
	</div>
	

	<div class="row data" style="margin-top: 10px">
		<div class="col-md-6">
			<textarea rows="4" cols="50"></textarea>
			<button class="run">Run Auction</button>
		</div>
	</div>

	<div class="row" style="margin-top: 10px;">
		<h3 class="results clearable"></h3>
		<div class="row">
			<div class="col-md-5 stackedBar clearable"></div>
			<!-- <div class="col-md-6 randomBar clearable"></div> -->
			<div class="col-md-7 output clearable"></div>
		</div>
	</div>


</div>

<script type="text/javascript">
	
$(document).ready(function(){

	d3.select(".toggle").on("click", function(){
		var that = $(this);
		$(".toggle-list").slideToggle(function() { 
			$(this).is(":visible") ? that.text("Hide Instructions") : that.text("Show Instructions");
        });
		return false;
	});

	d3.select(".run").on("click", function(){

	d3.selectAll(".clearable").selectAll("*").remove()

	var textput = $("textarea").val()

		// Given a CSV with each column representing a person's alphabetically (by name of items)
	// listed preferences
	var data = [];

	d3.tsv.parse(textput, function(x){ data.push(x)});

	if(!data || !data.length) return;

	var totals = {}
	data.forEach(function(rows){
	 	Object.keys(rows).forEach(function(el, i, arr){
	 		if(el != "Names") totals[el] = Number(rows[el]) + totals[el] || Number(rows[el])
	 	});
	});

	data.forEach(function(rows, i, arr){
	 	Object.keys(rows).forEach(function(el, i, arr){
	 		if(el != "Names") rows[el] = Number(rows[el]) / totals[el] * 100;
	 	});
	});

	debugger;

	var currentUtilities = {}
	
	Object.keys(data[0]).forEach(function(el, index, arr){
		currentUtilities[el] = 0;
	});

	for(var i = 0; i < data.length; i++){
		Object.keys(data[i]).forEach(function(el, index, arr){
			if(el != "Names") data[i][el] = Number(data[i][el]);
		})
	}

	var heighestFirst = function(){
		var order = [];
		data.sort(function(a,b) {
			var sumA = 0;
			var sumB = 0;
			for(var i in a){
				if(i != "Names"){
					sumA += a[i];
					sumB += b[i]
				}
			}
			return sumB - sumA;
		});
	}

	var algo = function(numSteps){
		var winners = []

		var nonNames = data.map(function(el,i, arr){
			var exclude = {};
			for(j in el){
				if(j != "Names") {
					exclude[j] = el[j]
				};
			}
			return exclude;
		});

		var names = data.map(function(el, i, arr){ return el.Names });


		for(var i = 0; i < numSteps; i++){
			var winner = updateCurrentUtility(i, nonNames, names);
			winners.push(winner);
		}
		return winners;
	}

	var tieBreaker = function(row, el1, el2, nonNames){
		for(var i = row; i < data.length; i++){
			if(nonNames[i][el1] == nonNames[i][el2]){
				continue;
			} else if(nonNames[i][el1] == nonNames[i][el2]){
				return el2;
			} else {
				return el1;
			}
		}
		return Math.random() > .5 ? el1 : el2
	}

	var redistributeWinnings = function(row, exclude, nonNames){
		for(var el in data[0]){
			if(el == exclude){
			} else{
				var remainingWeight = 0;
				var currWeight = nonNames[row][el];

				for(var k = row+1; k < nonNames.length; k++){
					remainingWeight += nonNames[k][el];
				}

				for(var k = row+1; k < data.length; k++){
					nonNames[k][el] += currWeight * (nonNames[k][el]/remainingWeight);
				}
			}
		}
	}

	var updateCurrentUtility = function(row, nonNames, names){
		var oneStepAheadUtil = {}
		Object.keys(nonNames[row]).forEach(function(el, index, arr){
			oneStepAheadUtil[el] = currentUtilities[el] + nonNames[row][el];
		});

		var marginalUtil = {}
		Object.keys(nonNames[row]).forEach(function(el, index, arr){
			marginalUtil[el] = Math.sqrt(oneStepAheadUtil[el]) - Math.sqrt(currentUtilities[el]);
		});

		var maxUtil = {key: "", value: 0};
		for(i in marginalUtil){
			if(maxUtil["value"] < marginalUtil[i]){
				maxUtil["key"] = i;
				maxUtil["value"] = marginalUtil[i];
			} else if(maxUtil["value"] == marginalUtil[i]){
				if(maxUtil["key"] == ""){
					maxUtil["key"] = i;
				} else {
					maxUtil["key"] = tieBreaker(row, maxUtil["key"], i, nonNames);
				}
			}
		}

		currentUtilities[maxUtil["key"]] = oneStepAheadUtil[maxUtil["key"]];

		redistributeWinnings(row, maxUtil["key"], nonNames);

		return {"key": maxUtil["key"], "marginalUtil": data[row][maxUtil["key"]], "item": names[row]};
	}

	var randomAlgo = function(numSteps){

		var winners = []

		var nonNames = data.map(function(el,i, arr){
			var exclude = {};
			for(j in el){
				if(j != "Names") {
					exclude[j] = el[j]
				};
			}
			return exclude;
		});

		var names = data.map(function(el, i, arr){ return el.Names });


		for(var i = 0; i < numSteps; i++){

			var wIndex = Math.round(Math.random() * Object.keys(nonNames[i]).length)

			var key = Object.keys(nonNames[i])[wIndex];

			var util = nonNames[i][key];

			var winner = {"key": key, "marginalUtil": util, item: names[i]};

			winners.push(winner);
		}

		return winners;
	}
	
	heighestFirst();

	var winners = algo(data.length);

	d3.select(".results")
		.text("Results");


	var myStackedBar = new StackedBar(d3.select(".stackedBar"), winners, true, "Utilis: Custom Algorithm");

	// var rands = randomAlgo(data.length);
	// var myStackedBar2 = new StackedBar(d3.select(".randomBar"), rands, true, "Utilis: Random Algorithm");

	var nested_data = d3.nest()
		.key(function(d) { return d.key; })
		.entries(winners);

	d3.select(".output")
	.append("h3").text("Winnings");

	var utils = d3.select(".output")
	.selectAll(".totalUtil")
		.data(nested_data).enter()
		.append("div")
		.attr("class", "col-md-3");

	utils.append("b").text(function(x) {return x.key})
	utils.selectAll(".infos")
		.data(function(x){return x.values}).
		enter().append("div")
		.html(function(x){return "<h4>Item:</h4> " + x.item + '<br><span><h4">Utils:</h4><p>' + d3.round(x.marginalUtil, 2)});
	});
});
</script>
</body>
</html>